<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Debian | Треск и скрежет в моей голове]]></title>
  <link href="http://blog.alfss.net//blog/categories/debian/atom.xml" rel="self"/>
  <link href="http://blog.alfss.net//"/>
  <updated>2012-11-06T03:35:20+04:00</updated>
  <id>http://blog.alfss.net//</id>
  <author>
    <name><![CDATA[Sergey V. Kravchuk]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Создание deb пакетов на примере postgresql 9.0]]></title>
    <link href="http://blog.alfss.net//post/2012/03/04/sozdaniie-deb-pakietov-na-primierie-postgresql/"/>
    <updated>2012-03-04T16:09:00+04:00</updated>
    <id>http://blog.alfss.net//post/2012/03/04/sozdaniie-deb-pakietov-na-primierie-postgresql</id>
    <content type="html"><![CDATA[<p>Есть несколько способов создать пакет:</p>

<ol>
<li>Скачать через apt-get source postgres сырцы предыдущей версии и забрать каталог debian из них.</li>
<li>Checkinstall</li>
<li>Написать свой пакет.</li>
</ol>


<p>Как не печально, но на первый способ я угрохал больше дня и ничего не вышло. Ибо в постгресе поменялись некоторые файлы.</p>

<p>Второй способ меня разочаровал тем,что там не было возможности добавить init.d скрипт и postinst  ,preinst триггеры.</p>

<p>Собственно дальше я буду описывать 3й способ.</p>

<!--more-->


<h3>Рабочее окружение.</h3>

<p>Подготавливаем директории для сборки и скачиваем дистрибутивы.</p>

<p>{% codeblock lang:bash %}
DEBEMAIL=your.email.address@example.org
DEBFULLNAME="Firstname Lastname"
export DEBEMAIL DEBFULLNAME</p>

<p>mkdir -p ~/build_deb/postgres/9.0
cd ~/build_deb/postgres/9.0
wget http://wwwmaster.postgresql.org/download/mirrors-ftp/source/v9.0.1/postgresql-9.0.1.tar.gz
tar zxf postgresql-9.0.1.tar.gz
cp postgresql-9.0.1.tar.gz postgresql-9.0.1.orig.tar.gz
mv postgresql-9.0.1 postgresql-9.0-9.0.1
{% endcodeblock %}</p>

<p>Инициализируем каркас deb пакета:</p>

<p>{% codeblock lang:bash %}
cd postgresql-9.0-9.0.1
dh_make</p>

<h1>Нам зададут вопрос какого типа этот пакет, я выбрал single</h1>

<p>Type of package: single binary, multiple binary, library, kernel module or cdbs?
[s/m/l/k/b] s
{% endcodeblock %}</p>

<p>Если ваши исходники используют для сборки autotools то вам неимоверно повезло.</p>

<p>Соберем информацию о требуемых зависимостях:</p>

<p>{% codeblock lang:bash %}
dpkg-depcheck -d ./configure --with-libxml \
--with-libxml \
--with-libxslt \
--with-openssl \
--with-ldap \
--with-pam \
--with-perl \
--with-python \
--with-tcl \
--with-ossp-uuid \
--prefix=/usr \
--datadir=/usr/share/postgresql
{% endcodeblock %}</p>

<p>У меня получился следуюший список:</p>

<p>{% codeblock %}
autotools-dev,sp,
hardening-wrapper,
libsasl2-2,
libldap2-dev,
libtasn1-3,
sgml-data,
mawk,
docbook,
libk5crypto3,
python2.6,
python-support,
libkrb5support0,
tcl,
libossp-uuid-dev,
libgpg-error0,
libpam0g-dev,
libgcrypt11,
libreadline6-dev,
libsp1c2,
flex,
libkeyutils1,
docbook-xml,
libgnutls26,
libssl-dev,
libkrb5-3,
libgssapi-krb5-2,
tcl8.4-dev,
libxslt1-dev
{% endcodeblock %}</p>

<p>Теперь можно приступить к редактированию файлов в debian/ каталоге.
Если зайти в данную директорию то можно увидеть шаблоны файлов с расширением “.ex”(example)</p>

<p>Файлы которые интересовали меня :</p>

<ul>
<li>changelog</li>
<li>control</li>
<li>init.d</li>
<li>postgresql-9.0.postinst</li>
<li>postgresql-9.0.default</li>
<li>postgresql-9.0.preinst</li>
<li>rules</li>
</ul>


<h3>changelog</h3>

<p>Собственно файл в котором ведется лог изменения пакета. А так же из него при генерации берется версия.
{% codeblock %}
postgresql-9.0 (9.0.1-0ubuntu10.04) unstable; urgency=low</p>

<ul>
<li>Initial release (Closes: #nnnn)  <nnnn is the bug number of your ITP></li>
</ul>


<p>-- Kravchuk Sergey <a href="&#109;&#97;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#x61;&#x6c;&#102;&#x73;&#x73;&#x2e;&#x6f;&#x62;&#x73;&#100;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#111;&#109;">&#x61;&#108;&#102;&#x73;&#115;&#x2e;&#111;&#x62;&#x73;&#100;&#64;&#103;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#109;</a>  Fri, 12 Nov 2010 21:25:56 +0300
{% endcodeblock %}</p>

<h3>control</h3>

<p>Описывает какие пакеты будут собраны и какие зависимости.
{% codeblock %}
Source: postgresql-9.0
Section: database
Priority: extra
Maintainer: Kravchuk Sergey <a href="&#109;&#x61;&#105;&#108;&#x74;&#x6f;&#x3a;&#x61;&#108;&#x66;&#115;&#x73;&#x2e;&#111;&#98;&#x73;&#x64;&#64;&#103;&#x6d;&#97;&#105;&#x6c;&#46;&#99;&#x6f;&#x6d;">&#97;&#x6c;&#x66;&#115;&#115;&#46;&#x6f;&#98;&#x73;&#100;&#x40;&#x67;&#109;&#97;&#x69;&#x6c;&#46;&#x63;&#x6f;&#x6d;</a>
Build-Depends: debhelper (>= 7), autotools-dev,sp, hardening-wrapper, libsasl2-2, libldap2-dev, libtasn1-3, sgml-data, mawk, docbook, libk5crypto3, python2.6, python-support, libkrb5support0, tcl, libossp-uuid-dev, libgpg-error0, libpam0g-dev, libgcrypt11, libreadline6-dev, libsp1c2, flex, libkeyutils1, docbook-xml, libgnutls26, libssl-dev, libkrb5-3, libgssapi-krb5-2, tcl8.4-dev, libxslt1-dev
Standards-Version: 3.8.3
Homepage: http://www.postgresql.org/</p>

<p>Package: postgresql-9.0
Architecture: any
Depends: ${shlibs:Depends}, ${misc:Depends}
Description: PostgreSQL 9.0
Database SQL server. Build Sergey Kravchuk.
{% endcodeblock %}</p>

<h3>init.d</h3>

<p>Скрипт старта</p>

<p>{% codeblock lang:bash %}</p>

<h1>! /bin/sh</h1>

<p>#</p>

<h1>skeleton      example file to build /etc/init.d/ scripts.</h1>

<h1>This file should be used to construct scripts for /etc/init.d.</h1>

<p>#</p>

<h1>Written by Miquel van Smoorenburg .</h1>

<h1>Modified for Debian</h1>

<h1>by Ian Murdock .</h1>

<h1>Further changes by Javier Fernandez-Sanguino</h1>

<p>#</p>

<h1>Version:      @(#)skeleton  1.9  26-Feb-2001  miquels@cistron.nl</h1>

<p>#</p>

<p>PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/usr/bin/postgres
NAME=postgres
DESC=postgres</p>

<p>test -x $DAEMON || exit 0</p>

<p>LOGDIR=/var/log/postgres
PIDFILE=/var/run/$NAME.pid
DODTIME=1                   # Time to wait for the server to die, in seconds</p>

<h1>If this value is set too low you might not</h1>

<h1>let some servers to die gracefully and</h1>

<h1>'restart' will not work</h1>

<h1>Include postgresql-9.0 defaults if available</h1>

<p>if [ -f /etc/default/postgresql-9.0 ] ; then
  . /etc/default/postgresql-9.0
fi</p>

<p>set -e</p>

<p>running_pid()
{</p>

<h1>Check if a given process pid's cmdline matches a given name</h1>

<p>  pid=$1
  name=$2
  [ -z "$pid" ] &amp;&amp; return 1
  [ ! -d /proc/$pid ] &amp;&amp;  return 1
  cmd=<code>cat /proc/$pid/cmdline | tr "\000" "\n"|head -n 1 |cut -d : -f 1</code></p>

<h1>Is this the expected child?</h1>

<p>  [ "$cmd" != "$name" ] &amp;&amp;  return 1
  return 0
}</p>

<p>running()
{</p>

<h1>Check if the process is running looking at /proc</h1>

<h1>(works for all users)</h1>

<h1>No pidfile, probably no daemon present</h1>

<p>  [ ! -f "$PIDFILE" ] &amp;&amp; return 1</p>

<h1>Obtain the pid and check it against the binary name</h1>

<p>  pid=<code>cat $PIDFILE</code>
  running_pid $pid $DAEMON || return 1
  return 0
}</p>

<p>force_stop() {</p>

<h1>Forcefully kill the process</h1>

<p>  [ ! -f "$PIDFILE" ] &amp;&amp; return
  if running ; then</p>

<pre><code>kill -15 $pid
</code></pre>

<h1>Is it really dead?</h1>

<pre><code>[ -n "$DODTIME" ] &amp;&amp; sleep "$DODTIME"s
if running ; then
  kill -9 $pid
  [ -n "$DODTIME" ] &amp;&amp; sleep "$DODTIME"s
  if running ; then
    echo "Cannot kill $LABEL (pid=$pid)!"
    exit 1
  fi
fi
</code></pre>

<p>  fi
  rm -f $PIDFILE
  return 0
}</p>

<p>case "$1" in
  start)</p>

<pre><code>echo -n "Starting $DESC: "
start-stop-daemon --start -b -m --quiet -c $NAME --pidfile $PIDFILE \
  --exec $DAEMON -- $DAEMON_OPTS
if running ; then
  echo "$NAME."
else
  echo " ERROR."
  fi
</code></pre>

<p>  ;;
  stop)</p>

<pre><code>echo -n "Stopping $DESC: "
start-stop-daemon --stop  --quiet -c $NAME --pidfile $PIDFILE \
  --exec $DAEMON
echo "$NAME."
</code></pre>

<p>  ;;
  restart)
  echo -n "Restarting $DESC: "
  start-stop-daemon --stop -c $NAME --quiet --pidfile $PIDFILE \</p>

<pre><code>--exec $DAEMON
</code></pre>

<p>  [ -n "$DODTIME" ] &amp;&amp; sleep $DODTIME
  start-stop-daemon --start -m -b -c $NAME --quiet --pidfile $PIDFILE \</p>

<pre><code>--exec $DAEMON -- $DAEMON_OPTS
</code></pre>

<p>  echo "$NAME."
  ;;
  status)</p>

<pre><code>echo -n "$LABEL is "
</code></pre>

<p>  if running ;  then</p>

<pre><code>echo "running"
</code></pre>

<p>  else</p>

<pre><code>echo " not running."
</code></pre>

<p>  exit 1
  fi
  ;;
  initdb)</p>

<pre><code>echo -n "Init DB Dir: "
su -c "initdb $INITDB_OPTS" -m $NAME
echo "$NAME."
;;
</code></pre>

<p>  *)</p>

<pre><code>N=/etc/init.d/$NAME-9.0
</code></pre>

<h1>echo "Usage: $N {start|stop|restart|reload|force-reload}" >&amp;2</h1>

<pre><code>echo "Usage: $N {start|stop|restart|status|initdb}" &gt;&amp;2
exit 1
</code></pre>

<p>  ;;
esac</p>

<p>exit 0
{% endcodeblock %}</p>

<h3>postgresql-9.0.postinst</h3>

<p>Скрипт выполняемый после установки.
{% codeblock lang:bash %}</p>

<h1>!/bin/sh</h1>

<p>if [ -d /var/lib/postgresql-9.0 ]
  then</p>

<pre><code>echo "postgres dir enable"
</code></pre>

<p>  else</p>

<pre><code>mkdir /var/lib/postgresql-9.0
chown -R postgres /var/lib/postgresql-9.0
su -c 'initdb -U postgres --encoding=utf-8 --locale=ru_RU.UTF-8 /var/lib/postgresql-9.0' -m  postgres
</code></pre>

<p>  fi
{% endcodeblock %}</p>

<h3>postgresql-9.0.default</h3>

<p>Файл который будет лежать по следуюшиму пути /etc/default/postgresql-9.0. Используется для изменения опций старта.
{% codeblock lang:bash %}</p>

<h1>Defaults for postgresql-9.0.1 initscript</h1>

<h1>sourced by /etc/init.d/postgresql-9.0.1</h1>

<h1>installed at /etc/default/postgresql-9.0.1 by the maintainer scripts</h1>

<p>#</p>

<h1>This is a POSIX shell fragment</h1>

<p>#</p>

<h1>Additional options that are passed to the Daemon.</h1>

<p>DAEMON_OPTS="-D /var/lib/postgresql-9.0"
INITDB_OPTS=" -U postgres --encoding=utf-8 --locale=ru_RU.UTF-8 /var/db/postgresql-9.0 "</p>

<p>{% endcodeblock %}</p>

<h3>postgresql-9.0.preinst</h3>

<p>Скрипт выполняемый до установки.
{% codeblock lang:bash %}</p>

<h1>!/bin/sh -e</h1>

<p>if [ "$(id -u postgres)" != "999" ]; then
  useradd -s /usr/sbin/nologin -d /nonexistent -r -u 999 postgres
fi
{% endcodeblock %}</p>

<h3>rules</h3>

<p>Этот файл отвечает за действия которые будут выполнены при создании пакета.
{% codeblock lang:bash %}</p>

<h1>!/usr/bin/make -f</h1>

<h1>-<em>- makefile -</em>-</h1>

<h1>Sample debian/rules that uses debhelper.</h1>

<h1>This file was originally written by Joey Hess and Craig Small.</h1>

<h1>As a special exception, when this file is copied by dh-make into a</h1>

<h1>dh-make output file, you may use that output file without restriction.</h1>

<h1>This special exception was added by Craig Small in version 0.37 of dh-make.</h1>

<h1>Uncomment this to turn on verbose mode.</h1>

<h1>export DH_VERBOSE=1</h1>

<p>CONFIGURE_EXTRA_FLAGS= --with-libxml \</p>

<pre><code>    --with-libxml \
    --with-libxslt \
    --with-openssl \
    --with-ldap \
    --with-pam \
    --with-perl \
    --with-python \
    --with-tcl \
    --with-ossp-uuid \
    --prefix=/usr \
    --datadir=/usr/share/postgresql
</code></pre>

<p>%:</p>

<pre><code>    dh $@
</code></pre>

<h1>Собираем документацию , контрибы и постгрес</h1>

<p>override_dh_auto_build:</p>

<pre><code>    make world
</code></pre>

<p>override_dh_auto_configure:</p>

<pre><code>    ./configure ${CONFIGURE_EXTRA_FLAGS}
</code></pre>

<h1>Отключаем генерацию файлов с авто стартом и завершением после установки.</h1>

<p>override_dh_installinit:</p>

<pre><code>    dh_installinit -n
</code></pre>

<h1>Устанавливаем все в fakeroot</h1>

<p>override_dh_auto_install:</p>

<pre><code>    make install-world \
     DESTDIR=`pwd`/debian/postgresql-9.0/
</code></pre>

<p>{% endcodeblock %}</p>

<h3>Сборка пакета</h3>

<p>Собственно завершающий этап.
Сборка пакета(выполняется в каталоге с исходным кодом):
{% codeblock %}
dpkg-buildpackage -rfakeroot -j4
{% endcodeblock %}</p>

<p>На выходе мы получим следующие файлы:</p>

<ul>
<li>postgresql-9.0_9.0.1-0ubuntu10.04.dsc</li>
<li>postgresql-9.0_9.0.1-0ubuntu10.04.tar.gz</li>
<li>postgresql-9.0_9.0.1-0ubuntu10.04_amd64.deb</li>
<li>postgresql-9.0_9.0.1-0ubuntu10.04_amd64.changes</li>
</ul>


<p>Дальше уже ваше дело как с этим поступать.</p>

<p>Ссылки которые помогут:</p>

<ul>
<li>http://www.mapbender.org/Deb_Package</li>
<li>http://tldp.org/HOWTO/html_single/Debian-Binary-Package-Building-HOWTO/</li>
<li>http://www.debian.org/doc/maint-guide/</li>
<li>http://wiki.debian.org/DebianRussian/deb-inside</li>
</ul>

]]></content>
  </entry>
  
</feed>
