<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: vpn | Треск и скрежет в моей голове]]></title>
  <link href="http://blog.alfss.net//blog/categories/vpn/atom.xml" rel="self"/>
  <link href="http://blog.alfss.net//"/>
  <updated>2012-11-06T03:35:20+04:00</updated>
  <id>http://blog.alfss.net//</id>
  <author>
    <name><![CDATA[Sergey V. Kravchuk]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[OpenVPN + аутентификация по логину и паролю]]></title>
    <link href="http://blog.alfss.net//post/2012/10/26/openvpn-plus-autientifikatsiia-po-loghinu-i-paroliu/"/>
    <updated>2012-10-26T22:09:00+04:00</updated>
    <id>http://blog.alfss.net//post/2012/10/26/openvpn-plus-autientifikatsiia-po-loghinu-i-paroliu</id>
    <content type="html"><![CDATA[<p>Мне потребовался доступ к внутренней сети и я решил использовать openvpn для этих целей.
Поскольку LDAP на этот момент еще нету, аутентификация будет на основе файла с паролями в md5.</p>

<h3>Устанавливаем необходимые пакеты</h3>

<p>{% codeblock %}
sudo apt-get install openvpn
{% endcodeblock %}</p>

<!--more-->


<h3>Создание сертификатов</h3>

<p>Идем в /usr/share/doc/openvpn/examples/easy-rsa/2.0/ и выполняем следующие действия.
{% codeblock %}
sh
. ./vars
 ./clean-all
{% endcodeblock %}</p>

<p>Создаем CA сертификат.
{% codeblock %}
./build-ca
{% endcodeblock %}</p>

<ul>
<li>Country Name – 2х буквенный код страны (RU)</li>
<li>State or Province Name (full name) – Государство или название провинции (Russia)</li>
<li>Locality Name (eg, city) – Город (Saint-Peterburg)</li>
<li>Organization Name (eg, company) – Компания(Astrotech SPB)</li>
<li>Organizational Unit Name – Подразделении выдавшие сертификат (IT)</li>
<li>Common Name – имя сервера для которого предназначается сертификат (vpn.spb.astrotech-co.ru)</li>
<li>Email Address – email организации (suppoer@astrotech-co.ru)</li>
</ul>


<p>Создаем X.509 сертификатов для сервера.
{% codeblock %}
./build-key-server server
{% endcodeblock %}</p>

<p>Создайте ключ Диффи Хельман.
{% codeblock %}
openvpn --genkey --secret ta.key
{% endcodeblock %}</p>

<h3>Настройка OpenVPN</h3>

<p>Создадим директории для файлов.
{% codeblock %}</p>

<h1>ключи и сертификаты</h1>

<p>mkdir /etc/openvpn/keys</p>

<h1>скрипт для авторизации</h1>

<p>mkdir /etc/openvpn/auth
{% endcodeblock %}</p>

<p>В директорию /etc/openvpn/keys должны быть скопированы следующие файлы из /usr/share/doc/openvpn/examples/easy-rsa/2.0:</p>

<ul>
<li>ca.crt</li>
<li>dh1024.pem</li>
<li>server.crt</li>
<li>server.key</li>
<li>ta.key</li>
</ul>


<p>Конфиг сервера /etc/openvpn/openvpn.conf.
Опции описывать не буду ибо это просто посмотреть в документации.
{% codeblock %}
script-security 3
tmp-dir /tmp
port 1194
proto tcp
dev tun0
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
client-cert-not-required
key /etc/openvpn/keys/server.key
dh /etc/openvpn/keys/dh1024.pem
server 10.8.0.0 255.255.255.0
push "route 192.168.0.0 255.255.255.0"
push "dhcp-option DNS 192.168.0.1"
tls-server
tls-auth /etc/openvpn/keys/ta.key 0
tls-timeout 120
auth MD5
cipher BF-CBC
keepalive 10 120
comp-lzo
max-clients 100
user nobody
group nogroup
persist-key
persist-tun
status /var/log/openvpn/openvpn-status.log
log /var/log/openvpn/openvpn.log
verb 4
auth-user-pass-verify /etc/openvpn/auth/auth-static-file.pl via-file
route 10.8.0.0 255.255.255.0
{% endcodeblock %}</p>

<h3>Скрипт авторизации.</h3>

<p>/etc/openvpn/auth/auth-static-file.pl:
{% codeblock lang:perl %}</p>

<h1>!/usr/bin/perl</h1>

<p>#</p>

<h1>$Id$</h1>

<p>#</p>

<h1>Кравчук Сергей, <a href="&#109;&#x61;&#105;&#x6c;&#116;&#x6f;&#x3a;&#97;&#108;&#102;&#115;&#115;&#x2e;&#111;&#x62;&#115;&#x64;&#64;&#103;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;">&#x61;&#x6c;&#x66;&#x73;&#x73;&#46;&#x6f;&#98;&#x73;&#100;&#64;&#x67;&#109;&#97;&#105;&#108;&#46;&#99;&#x6f;&#109;</a></h1>

<p>#</p>

<p>use strict;
use warnings;
use Digest::MD5  qw(md5 md5_hex md5_base64);
use version; our $VERSION = qv(0.01);</p>

<p>my $password_file = '/etc/openvpn/auth/user_password.txt';
my $ARG = undef;
if ( $ARG = shift @ARGV ) {</p>

<pre><code>if ( !open( UPFILE, "&lt;$ARG" ) ) {
    print "Could not open username/password tmp file: $ARG\n";
    exit 1;
}
</code></pre>

<p>}
else {</p>

<pre><code>print "No username/password file specified on command line\n";
exit 1;
</code></pre>

<p>}</p>

<p>my $username = <UPFILE>;
my $password = <UPFILE>;</p>

<p>if ( !$username || !$password ) {</p>

<pre><code>print "Username/password not found in tmp file: $ARG\n";
exit 1;
</code></pre>

<p>}</p>

<p>chomp $username;
chomp $password;</p>

<p>close(UPFILE);</p>

<p>if ( !open( USER_PASSWORD, "&lt;$password_file" ) ) {</p>

<pre><code>print "Could not open username/password db file: $ARG\n";
exit 1;
</code></pre>

<p>}
foreach my $line (<USER_PASSWORD>) {</p>

<pre><code>chomp($line);
my ( $read_user, $read_password ) = split(/:/, $line);
if ( $read_user eq $username ) {
    my $hex_password = md5_hex $password;
    if ( $hex_password eq $read_password) {
        close(USER_PASSWORD);
        exit 0;
    }
    exit 1;
}
</code></pre>

<p>}</p>

<p>close(USER_PASSWORD);</p>

<p>exit 1;
{% endcodeblock %}</p>

<h3>Конфиг клиента</h3>

<p>Клиент должен иметь следующие файлы:</p>

<ul>
<li>ca.crt</li>
<li>ta.key</li>
<li>vpn_config.ovpn</li>
</ul>


<p>Конфиг клиента:
{% codeblock %}
auth-user-pass
dev tun
proto tcp</p>

<h1>Внешний IP сервера OpenVPN</h1>

<p>remote 55.44.33.33</p>

<h1>Port сервера</h1>

<p>port 1194
client
resolv-retry infinite</p>

<h1>полный путь до сертификата</h1>

<p>ca "/Users/alfss/Documents/vpn/ca.crt"
tls-client</p>

<h1>полный путь до ключа</h1>

<p>tls-auth "/Users/alfss/Documents/vpn/ta.key" 1
auth MD5
cipher BF-CBC
ns-cert-type server
comp-lzo
persist-key
persist-tun
push "dhcp-option DNS 192.168.0.1"
verb 3
{% endcodeblock %}</p>

<h3>Добавление пользователя</h3>

<p>Генерация хэш для пароля:
{% codeblock %}
echo -n 'password' | md5sum
5f4dcc3b5aa765d61d8327deb882cf99
{% endcodeblock %}</p>

<p>файл (/etc/openvpn/auth/user_password.txt)  с пользвателями должен иметь следующий вид:
{% codeblock %}
user1:5f4dcc3b5aa765d61d8327deb882cf99
user2:5f4dcc3b5aa765d61d8327deb882cf99
user3:5f4dcc3b5aa765d61d8327deb882cf99</p>

<p>{% endcodeblock %}</p>

<p>Последний перевод строки обязателен.</p>
]]></content>
  </entry>
  
</feed>
