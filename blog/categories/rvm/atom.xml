<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: rvm | Треск и скрежет в моей голове]]></title>
  <link href="http://blog.alfss.net//blog/categories/rvm/atom.xml" rel="self"/>
  <link href="http://blog.alfss.net//"/>
  <updated>2012-11-06T03:35:20+04:00</updated>
  <id>http://blog.alfss.net//</id>
  <author>
    <name><![CDATA[Sergey V. Kravchuk]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Установка redmine (Ubuntu 12.04 LTS)]]></title>
    <link href="http://blog.alfss.net//post/2012/10/26/ustanovka-redmine-ubuntu-12-dot-04-lts/"/>
    <updated>2012-10-26T22:10:00+04:00</updated>
    <id>http://blog.alfss.net//post/2012/10/26/ustanovka-redmine-ubuntu-12-dot-04-lts</id>
    <content type="html"><![CDATA[<p>Я считаю что ставить rails приложения лучше всего через RVM.
Ниже описаны действия для развертывания redmine на только что установленной системе.</p>

<h3>Подготавливаем окружение</h3>

<p>Устанавливаем необходимые пакеты.
{% codeblock %}
sudo apt-get install imagemagick build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion pkg-config libpq-dev build-essential bison openssl libreadline5 libreadline-dev curl git-core zlib1g zlib1g-dev libssl-dev vim libsqlite3-0 libsqlite3-dev sqlite3 libreadline-dev libxml2-dev git-core subversion autoconf curl git-core  libmagickcore-dev libmagickwand-dev
{% endcodeblock %}</p>

<!--more-->


<p>Создаем пользователя для запуска приложения.
{% codeblock %}
sudo useradd -u 2001 -m -s/bin/bash rails
passwd rails
{% endcodeblock %}</p>

<p>Устанавливаем rvm.
{% codeblock %}
ssh rails@localhost
echo insecure >> ~/.curlrc
bash -s stable &lt; &lt;(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer )
rvm install 1.9.2-head
exit
{% endcodeblock %}</p>

<h3>Устанавливаем redmine</h3>

<p>Я предпочитаю хранить все rails приложения в директории /spool/rails.
{% codeblock %}
sudo mkdir  -p /spool/rails
cd /spool/rails
sudo svn co http://redmine.rubyforge.org/svn/branches/2.0-stable redmine-2.0
sudo chown -R rails:rails  /spool/rails/redmine-2.0
{% endcodeblock %}</p>

<p>{% codeblock %}
ssh rails@localhost
cd /spool/rails/redmine-2.0
bundle install --without development test
mkdir -p /spool/rails/redmine-2.0/tmp/pids/
exit
{% endcodeblock %}</p>

<h3>Настраиваем redmine и unicorn</h3>

<p>Настройка redmine в самом простом случае сводится к прописыванию доступов к БД.
Unicorn будте использоватся как сервер приложений.</p>

<p>Конфиг unicorn (/spool/rails/redmine-2.0/config/unicorn.rb)
{% codeblock %}
worker_processes 1
listen "127.0.0.1:8081", :tcp_nopush => true
timeout 90
pid "/spool/rails/redmine-2.0/tmp/pids/unicorn.pid"
working_directory "/spool/rails/redmine-2.0"
{% endcodeblock %}</p>

<p>Прописываем доступы к БД (/spool/rails/redmine-2.0/config/database.yml)
{% codeblock %}
production:
  adapter: postgresql
  database: redmine
  host: db.server.ru
  username: redmine
  password: "password"
{% endcodeblock %}</p>

<p>Стартовый скрипт unicorn /etc/init.d/unicorn_redmine
{% codeblock lang:bash %}</p>

<h1>!/bin/bash</h1>

<h3>BEGIN INIT INFO</h3>

<h1>Provides:          redmine</h1>

<h1>Required-Start:    $all</h1>

<h1>Required-Stop:     $network $local_fs $syslog</h1>

<h1>Default-Start:     2 3 4 5</h1>

<h1>Default-Stop:      0 1 6</h1>

<h1>Short-Description: Start the APPLICATION unicorns at boot</h1>

<h1>Description:       Enable APPLICATION at boot time.</h1>

<h3>END INIT INFO</h3>

<h1></h1>

<h1>Use this as a basis for your own Unicorn init script.</h1>

<h1>Change APPLICATION to match your app.</h1>

<h1>Make sure that all paths are correct.</h1>

<p>set -u
set -e</p>

<h1>Change these to match your app:</h1>

<p>APP_NAME="redmine"
APP_ROOT="/spool/rails/redmine-2.0"
PID="/spool/rails/redmine-2.0/tmp/pids/unicorn.pid"
ENV=production</p>

<p>GEM_HOME="/home/rails/.rvm/gems/ruby-1.9.2-head"</p>

<p>UNICORN_OPTS="-D -E $ENV -c $APP_ROOT/config/unicorn.rb"</p>

<p>SET_PATH="cd $APP_ROOT; rvm use 1.9.2-head; export GEM_HOME=$GEM_HOME"
CMD="$SET_PATH; /home/rails/.rvm/bin/rvm-shell 'default' -c 'bundle exec unicorn $UNICORN_OPTS'"</p>

<p>old_pid="$PID.oldbin"</p>

<p>cd $APP_ROOT || exit 1</p>

<p>sig () {</p>

<pre><code>test -s "$PID" &amp;&amp; kill -$1 `cat $PID`
</code></pre>

<p>}</p>

<p>oldsig () {</p>

<pre><code>test -s $old_pid &amp;&amp; kill -$1 `cat $old_pid`
</code></pre>

<p>}</p>

<p>case ${1-help} in
start)</p>

<pre><code>sig 0 &amp;&amp; echo &gt;&amp;2 "Already running" &amp;&amp; exit 0
su - rails -c "$CMD"
;;
</code></pre>

<p>stop)</p>

<pre><code>sig QUIT &amp;&amp; exit 0
echo &gt;&amp;2 "Not running"
;;
</code></pre>

<p>force-stop)</p>

<pre><code>sig TERM &amp;&amp; exit 0
echo &gt;&amp;2 "Not running"
;;
</code></pre>

<p>restart|reload)</p>

<pre><code>sig HUP &amp;&amp; echo reloaded OK &amp;&amp; exit 0
echo &gt;&amp;2 "Couldn't reload, starting '$CMD' instead"
su - rails -c "$CMD"
;;
</code></pre>

<p>upgrade)</p>

<pre><code>sig USR2 &amp;&amp; exit 0
echo &gt;&amp;2 "Couldn't upgrade, starting '$CMD' instead"
su - rails -c "$CMD"
;;
</code></pre>

<p>rotate)</p>

<pre><code>sig USR1 &amp;&amp; echo rotated logs OK &amp;&amp; exit 0
echo &gt;&amp;2 "Couldn't rotate logs" &amp;&amp; exit 1
;;
</code></pre>

<p>*)</p>

<pre><code>echo &gt;&amp;2 "Usage: $0 &lt;start|stop|restart|upgrade|rotate|force-stop&gt;"
exit 1
;;
</code></pre>

<p>esac
{% endcodeblock %}</p>

<h3>Инициализируем session, БД и вносим в авто-старт</h3>

<p>Генерируем ключ для session и БД.
{% codeblock %}
ssh rails@localhost
cd /spool/rails/redmine-2.0
rake generate_secret_token
RAILS_ENV=production rake db:migrate
exit
{% endcodeblock %}</p>

<p>Добавляем в автостарт unicorn и запускаем.
{% codeblock %}
sudo update-rc.d unicorn_redmine defaults
sudo /etc/init.d/unicorn_redmine start
{% endcodeblock %}</p>
]]></content>
  </entry>
  
</feed>
