
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Создание deb пакетов на примере postgresql 9.0 - Треск и скрежет в моей голове</title>
	<meta name="author" content="Sergey V. Kravchuk">

	
	<meta name="description" content="Есть несколько способов создать пакет: Скачать через apt-get source postgres сырцы предыдущей версии и забрать каталог debian из них.
Checkinstall &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Треск и скрежет в моей голове" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	
</head>

<body>
	<div class="container">
		<div class="left-col">
			<header id="header" class="inner"><div class="profilepic">	
	<img src="/images/dp.jpg" alt="Profile Picture" style="width: 160px;">
</div>
<h1><a href="/">Треск и скрежет в моей голове</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<br/>
<h3 class="alignleft"></h3>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/ALF_SS" title="Twitter">Twitter</a>
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>
		</div>		
		<div class="mid-col">
			
				
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/ALF_SS">ALF_SS</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="/javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('ALF_SS', 4, false);
	})(jQuery);
</script>

			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post">
	<h1 class="title">Создание Deb пакетов на примере Postgresql 9.0</h1>
	<div class="entry-content"><p>Есть несколько способов создать пакет:</p>

<ol>
<li>Скачать через apt-get source postgres сырцы предыдущей версии и забрать каталог debian из них.</li>
<li>Checkinstall</li>
<li>Написать свой пакет.</li>
</ol>


<p>Как не печально, но на первый способ я угрохал больше дня и ничего не вышло. Ибо в постгресе поменялись некоторые файлы.</p>

<p>Второй способ меня разочаровал тем,что там не было возможности добавить init.d скрипт и postinst  ,preinst триггеры.</p>

<p>Собственно дальше я буду описывать 3й способ.</p>

<!--more-->


<h3>Рабочее окружение.</h3>

<p>Подготавливаем директории для сборки и скачиваем дистрибутивы.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">DEBEMAIL</span><span class="o">=</span>your.email.address@example.org
</span><span class='line'><span class="nv">DEBFULLNAME</span><span class="o">=</span><span class="s2">&quot;Firstname Lastname&quot;</span>
</span><span class='line'><span class="nb">export </span>DEBEMAIL DEBFULLNAME
</span><span class='line'>
</span><span class='line'>mkdir -p ~/build_deb/postgres/9.0
</span><span class='line'><span class="nb">cd</span> ~/build_deb/postgres/9.0
</span><span class='line'>wget http://wwwmaster.postgresql.org/download/mirrors-ftp/source/v9.0.1/postgresql-9.0.1.tar.gz
</span><span class='line'>tar zxf postgresql-9.0.1.tar.gz
</span><span class='line'>cp postgresql-9.0.1.tar.gz postgresql-9.0.1.orig.tar.gz
</span><span class='line'>mv postgresql-9.0.1 postgresql-9.0-9.0.1
</span></code></pre></td></tr></table></div></figure>


<p>Инициализируем каркас deb пакета:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>postgresql-9.0-9.0.1
</span><span class='line'>dh_make
</span><span class='line'><span class="c">#Нам зададут вопрос какого типа этот пакет, я выбрал single</span>
</span><span class='line'>Type of package: single binary, multiple binary, library, kernel module or cdbs?
</span><span class='line'><span class="o">[</span>s/m/l/k/b<span class="o">]</span> s
</span></code></pre></td></tr></table></div></figure>


<p>Если ваши исходники используют для сборки autotools то вам неимоверно повезло.</p>

<p>Соберем информацию о требуемых зависимостях:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dpkg-depcheck -d ./configure --with-libxml <span class="se">\</span>
</span><span class='line'>--with-libxml <span class="se">\</span>
</span><span class='line'>--with-libxslt <span class="se">\</span>
</span><span class='line'>--with-openssl <span class="se">\</span>
</span><span class='line'>--with-ldap <span class="se">\</span>
</span><span class='line'>--with-pam <span class="se">\</span>
</span><span class='line'>--with-perl <span class="se">\</span>
</span><span class='line'>--with-python <span class="se">\</span>
</span><span class='line'>--with-tcl <span class="se">\</span>
</span><span class='line'>--with-ossp-uuid <span class="se">\</span>
</span><span class='line'>--prefix<span class="o">=</span>/usr <span class="se">\</span>
</span><span class='line'>--datadir<span class="o">=</span>/usr/share/postgresql
</span></code></pre></td></tr></table></div></figure>


<p>У меня получился следуюший список:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>autotools-dev,sp,
</span><span class='line'>hardening-wrapper,
</span><span class='line'>libsasl2-2,
</span><span class='line'>libldap2-dev,
</span><span class='line'>libtasn1-3,
</span><span class='line'>sgml-data,
</span><span class='line'>mawk,
</span><span class='line'>docbook,
</span><span class='line'>libk5crypto3,
</span><span class='line'>python2.6,
</span><span class='line'>python-support,
</span><span class='line'>libkrb5support0,
</span><span class='line'>tcl,
</span><span class='line'>libossp-uuid-dev,
</span><span class='line'>libgpg-error0,
</span><span class='line'>libpam0g-dev,
</span><span class='line'>libgcrypt11,
</span><span class='line'>libreadline6-dev,
</span><span class='line'>libsp1c2,
</span><span class='line'>flex,
</span><span class='line'>libkeyutils1,
</span><span class='line'>docbook-xml,
</span><span class='line'>libgnutls26,
</span><span class='line'>libssl-dev,
</span><span class='line'>libkrb5-3,
</span><span class='line'>libgssapi-krb5-2,
</span><span class='line'>tcl8.4-dev,
</span><span class='line'>libxslt1-dev</span></code></pre></td></tr></table></div></figure>


<p>Теперь можно приступить к редактированию файлов в debian/ каталоге.
Если зайти в данную директорию то можно увидеть шаблоны файлов с расширением “.ex”(example)</p>

<p>Файлы которые интересовали меня :</p>

<ul>
<li>changelog</li>
<li>control</li>
<li>init.d</li>
<li>postgresql-9.0.postinst</li>
<li>postgresql-9.0.default</li>
<li>postgresql-9.0.preinst</li>
<li>rules</li>
</ul>


<h3>changelog</h3>

<p>Собственно файл в котором ведется лог изменения пакета. А так же из него при генерации берется версия.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgresql-9.0 (9.0.1-0ubuntu10.04) unstable; urgency=low
</span><span class='line'> 
</span><span class='line'>* Initial release (Closes: #nnnn)  &lt;nnnn is the bug number of your ITP>
</span><span class='line'> 
</span><span class='line'>-- Kravchuk Sergey &lt;alfss.obsd@gmail.com>  Fri, 12 Nov 2010 21:25:56 +0300</span></code></pre></td></tr></table></div></figure>


<h3>control</h3>

<p>Описывает какие пакеты будут собраны и какие зависимости.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source: postgresql-9.0
</span><span class='line'>Section: database
</span><span class='line'>Priority: extra
</span><span class='line'>Maintainer: Kravchuk Sergey &lt;alfss.obsd@gmail.com>
</span><span class='line'>Build-Depends: debhelper (>= 7), autotools-dev,sp, hardening-wrapper, libsasl2-2, libldap2-dev, libtasn1-3, sgml-data, mawk, docbook, libk5crypto3, python2.6, python-support, libkrb5support0, tcl, libossp-uuid-dev, libgpg-error0, libpam0g-dev, libgcrypt11, libreadline6-dev, libsp1c2, flex, libkeyutils1, docbook-xml, libgnutls26, libssl-dev, libkrb5-3, libgssapi-krb5-2, tcl8.4-dev, libxslt1-dev
</span><span class='line'>Standards-Version: 3.8.3
</span><span class='line'>Homepage: http://www.postgresql.org/
</span><span class='line'> 
</span><span class='line'>Package: postgresql-9.0
</span><span class='line'>Architecture: any
</span><span class='line'>Depends: ${shlibs:Depends}, ${misc:Depends}
</span><span class='line'>Description: PostgreSQL 9.0
</span><span class='line'>Database SQL server. Build Sergey Kravchuk.</span></code></pre></td></tr></table></div></figure>


<h3>init.d</h3>

<p>Скрипт старта</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/sh</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># skeleton      example file to build /etc/init.d/ scripts.</span>
</span><span class='line'><span class="c">#               This file should be used to construct scripts for /etc/init.d.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#               Written by Miquel van Smoorenburg .</span>
</span><span class='line'><span class="c">#               Modified for Debian</span>
</span><span class='line'><span class="c">#               by Ian Murdock .</span>
</span><span class='line'><span class="c">#               Further changes by Javier Fernandez-Sanguino</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Version:      @(#)skeleton  1.9  26-Feb-2001  miquels@cistron.nl</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span><span class='line'><span class="nv">DAEMON</span><span class="o">=</span>/usr/bin/postgres
</span><span class='line'><span class="nv">NAME</span><span class="o">=</span>postgres
</span><span class='line'><span class="nv">DESC</span><span class="o">=</span>postgres
</span><span class='line'>
</span><span class='line'><span class="nb">test</span> -x <span class="nv">$DAEMON</span> <span class="o">||</span> <span class="nb">exit </span>0
</span><span class='line'>
</span><span class='line'><span class="nv">LOGDIR</span><span class="o">=</span>/var/log/postgres
</span><span class='line'><span class="nv">PIDFILE</span><span class="o">=</span>/var/run/<span class="nv">$NAME</span>.pid
</span><span class='line'><span class="nv">DODTIME</span><span class="o">=</span>1                   <span class="c"># Time to wait for the server to die, in seconds</span>
</span><span class='line'><span class="c"># If this value is set too low you might not</span>
</span><span class='line'><span class="c"># let some servers to die gracefully and</span>
</span><span class='line'><span class="c"># &#39;restart&#39; will not work</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Include postgresql-9.0 defaults if available</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f /etc/default/postgresql-9.0 <span class="o">]</span> ; <span class="k">then</span>
</span><span class='line'>  . /etc/default/postgresql-9.0
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="k"> </span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'>running_pid<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="c"># Check if a given process pid&#39;s cmdline matches a given name</span>
</span><span class='line'>  <span class="nv">pid</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>  <span class="nv">name</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>  <span class="o">[</span> -z <span class="s2">&quot;$pid&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>1
</span><span class='line'>  <span class="o">[</span> ! -d /proc/<span class="nv">$pid</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>  <span class="k">return </span>1
</span><span class='line'>  <span class="nv">cmd</span><span class="o">=</span><span class="sb">`</span>cat /proc/<span class="nv">$pid</span>/cmdline | tr <span class="s2">&quot;\000&quot;</span> <span class="s2">&quot;\n&quot;</span>|head -n 1 |cut -d : -f 1<span class="sb">`</span>
</span><span class='line'><span class="c"># Is this the expected child?</span>
</span><span class='line'>  <span class="o">[</span> <span class="s2">&quot;$cmd&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$name&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>  <span class="k">return </span>1
</span><span class='line'>  <span class="k">return </span>0
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>running<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="c"># Check if the process is running looking at /proc</span>
</span><span class='line'><span class="c"># (works for all users)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># No pidfile, probably no daemon present</span>
</span><span class='line'>  <span class="o">[</span> ! -f <span class="s2">&quot;$PIDFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>1
</span><span class='line'><span class="c"># Obtain the pid and check it against the binary name</span>
</span><span class='line'>  <span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$PIDFILE</span><span class="sb">`</span>
</span><span class='line'>  running_pid <span class="nv">$pid</span> <span class="nv">$DAEMON</span> <span class="o">||</span> <span class="k">return </span>1
</span><span class='line'>  <span class="k">return </span>0
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>force_stop<span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="c"># Forcefully kill the process</span>
</span><span class='line'>  <span class="o">[</span> ! -f <span class="s2">&quot;$PIDFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
</span><span class='line'><span class="k">  if </span>running ; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">kill</span> -15 <span class="nv">$pid</span>
</span><span class='line'><span class="c"># Is it really dead?</span>
</span><span class='line'>    <span class="o">[</span> -n <span class="s2">&quot;$DODTIME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sleep <span class="s2">&quot;$DODTIME&quot;</span>s
</span><span class='line'>    <span class="k">if </span>running ; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">kill</span> -9 <span class="nv">$pid</span>
</span><span class='line'>      <span class="o">[</span> -n <span class="s2">&quot;$DODTIME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sleep <span class="s2">&quot;$DODTIME&quot;</span>s
</span><span class='line'>      <span class="k">if </span>running ; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Cannot kill $LABEL (pid=$pid)!&quot;</span>
</span><span class='line'>        <span class="nb">exit </span>1
</span><span class='line'>      <span class="k">fi</span>
</span><span class='line'><span class="k">    fi</span>
</span><span class='line'><span class="k">  fi</span>
</span><span class='line'><span class="k">  </span>rm -f <span class="nv">$PIDFILE</span>
</span><span class='line'>  <span class="k">return </span>0
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
</span><span class='line'>  start<span class="o">)</span>
</span><span class='line'>    <span class="nb">echo</span> -n <span class="s2">&quot;Starting $DESC: &quot;</span>
</span><span class='line'>    start-stop-daemon --start -b -m --quiet -c <span class="nv">$NAME</span> --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>      --exec <span class="nv">$DAEMON</span> -- <span class="nv">$DAEMON_OPTS</span>
</span><span class='line'>    <span class="k">if </span>running ; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot; ERROR.&quot;</span>
</span><span class='line'>      <span class="k">fi</span>
</span><span class='line'>  ;;
</span><span class='line'>  stop<span class="o">)</span>
</span><span class='line'>    <span class="nb">echo</span> -n <span class="s2">&quot;Stopping $DESC: &quot;</span>
</span><span class='line'>    start-stop-daemon --stop  --quiet -c <span class="nv">$NAME</span> --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>      --exec <span class="nv">$DAEMON</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>  ;;
</span><span class='line'>  restart<span class="o">)</span>
</span><span class='line'>  <span class="nb">echo</span> -n <span class="s2">&quot;Restarting $DESC: &quot;</span>
</span><span class='line'>  start-stop-daemon --stop -c <span class="nv">$NAME</span> --quiet --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>    --exec <span class="nv">$DAEMON</span>
</span><span class='line'>  <span class="o">[</span> -n <span class="s2">&quot;$DODTIME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sleep <span class="nv">$DODTIME</span>
</span><span class='line'>  start-stop-daemon --start -m -b -c <span class="nv">$NAME</span> --quiet --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>    --exec <span class="nv">$DAEMON</span> -- <span class="nv">$DAEMON_OPTS</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>  ;;
</span><span class='line'>  status<span class="o">)</span>
</span><span class='line'>    <span class="nb">echo</span> -n <span class="s2">&quot;$LABEL is &quot;</span>
</span><span class='line'>  <span class="k">if </span>running ;  <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;running&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot; not running.&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'>  ;;
</span><span class='line'>  initdb<span class="o">)</span>
</span><span class='line'>    <span class="nb">echo</span> -n <span class="s2">&quot;Init DB Dir: &quot;</span>
</span><span class='line'>    su -c <span class="s2">&quot;initdb $INITDB_OPTS&quot;</span> -m <span class="nv">$NAME</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;$NAME.&quot;</span>
</span><span class='line'>    ;;
</span><span class='line'>  *<span class="o">)</span>
</span><span class='line'>    <span class="nv">N</span><span class="o">=</span>/etc/init.d/<span class="nv">$NAME</span>-9.0
</span><span class='line'><span class="c"># echo &quot;Usage: $N {start|stop|restart|reload|force-reload}&quot; &gt;&amp;2</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;Usage: $N {start|stop|restart|status|initdb}&quot;</span> &gt;&amp;2
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'>  ;;
</span><span class='line'><span class="k">esac</span>
</span><span class='line'><span class="k"> </span>
</span><span class='line'><span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<h3>postgresql-9.0.postinst</h3>

<p>Скрипт выполняемый после установки.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d /var/lib/postgresql-9.0 <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;postgres dir enable&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'><span class="k">    </span>mkdir /var/lib/postgresql-9.0
</span><span class='line'>    chown -R postgres /var/lib/postgresql-9.0
</span><span class='line'>    su -c <span class="s1">&#39;initdb -U postgres --encoding=utf-8 --locale=ru_RU.UTF-8 /var/lib/postgresql-9.0&#39;</span> -m  postgres
</span><span class='line'>  <span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<h3>postgresql-9.0.default</h3>

<p>Файл который будет лежать по следуюшиму пути /etc/default/postgresql-9.0. Используется для изменения опций старта.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Defaults for postgresql-9.0.1 initscript</span>
</span><span class='line'><span class="c"># sourced by /etc/init.d/postgresql-9.0.1</span>
</span><span class='line'><span class="c"># installed at /etc/default/postgresql-9.0.1 by the maintainer scripts</span>
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This is a POSIX shell fragment</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Additional options that are passed to the Daemon.</span>
</span><span class='line'><span class="nv">DAEMON_OPTS</span><span class="o">=</span><span class="s2">&quot;-D /var/lib/postgresql-9.0&quot;</span>
</span><span class='line'><span class="nv">INITDB_OPTS</span><span class="o">=</span><span class="s2">&quot; -U postgres --encoding=utf-8 --locale=ru_RU.UTF-8 /var/db/postgresql-9.0 &quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>postgresql-9.0.preinst</h3>

<p>Скрипт выполняемый до установки.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh -e</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$(id -u postgres)&quot;</span> !<span class="o">=</span> <span class="s2">&quot;999&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>useradd -s /usr/sbin/nologin -d /nonexistent -r -u 999 postgres
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<h3>rules</h3>

<p>Этот файл отвечает за действия которые будут выполнены при создании пакета.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/make -f</span>
</span><span class='line'><span class="c"># -*- makefile -*-</span>
</span><span class='line'><span class="c"># Sample debian/rules that uses debhelper.</span>
</span><span class='line'><span class="c"># This file was originally written by Joey Hess and Craig Small.</span>
</span><span class='line'><span class="c"># As a special exception, when this file is copied by dh-make into a</span>
</span><span class='line'><span class="c"># dh-make output file, you may use that output file without restriction.</span>
</span><span class='line'><span class="c"># This special exception was added by Craig Small in version 0.37 of dh-make.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Uncomment this to turn on verbose mode.</span>
</span><span class='line'><span class="c">#export DH_VERBOSE=1</span>
</span><span class='line'><span class="nv">CONFIGURE_EXTRA_FLAGS</span><span class="o">=</span> --with-libxml <span class="se">\</span>
</span><span class='line'>        --with-libxml <span class="se">\</span>
</span><span class='line'>        --with-libxslt <span class="se">\</span>
</span><span class='line'>        --with-openssl <span class="se">\</span>
</span><span class='line'>        --with-ldap <span class="se">\</span>
</span><span class='line'>        --with-pam <span class="se">\</span>
</span><span class='line'>        --with-perl <span class="se">\</span>
</span><span class='line'>        --with-python <span class="se">\</span>
</span><span class='line'>        --with-tcl <span class="se">\</span>
</span><span class='line'>        --with-ossp-uuid <span class="se">\</span>
</span><span class='line'>        --prefix<span class="o">=</span>/usr <span class="se">\</span>
</span><span class='line'>        --datadir<span class="o">=</span>/usr/share/postgresql
</span><span class='line'>%:
</span><span class='line'>        dh <span class="nv">$@</span>
</span><span class='line'><span class="c">#Собираем документацию , контрибы и постгрес</span>
</span><span class='line'>override_dh_auto_build:
</span><span class='line'>        make world
</span><span class='line'>override_dh_auto_configure:
</span><span class='line'>        ./configure <span class="k">${</span><span class="nv">CONFIGURE_EXTRA_FLAGS</span><span class="k">}</span>
</span><span class='line'><span class="c">#Отключаем генерацию файлов с авто стартом и завершением после установки.</span>
</span><span class='line'>override_dh_installinit:
</span><span class='line'>        dh_installinit -n
</span><span class='line'><span class="c">#Устанавливаем все в fakeroot</span>
</span><span class='line'>override_dh_auto_install:
</span><span class='line'>        make install-world <span class="se">\</span>
</span><span class='line'>         <span class="nv">DESTDIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/debian/postgresql-9.0/
</span></code></pre></td></tr></table></div></figure>


<h3>Сборка пакета</h3>

<p>Собственно завершающий этап.
Сборка пакета(выполняется в каталоге с исходным кодом):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dpkg-buildpackage -rfakeroot -j4</span></code></pre></td></tr></table></div></figure>


<p>На выходе мы получим следующие файлы:</p>

<ul>
<li>postgresql-9.0_9.0.1-0ubuntu10.04.dsc</li>
<li>postgresql-9.0_9.0.1-0ubuntu10.04.tar.gz</li>
<li>postgresql-9.0_9.0.1-0ubuntu10.04_amd64.deb</li>
<li>postgresql-9.0_9.0.1-0ubuntu10.04_amd64.changes</li>
</ul>


<p>Дальше уже ваше дело как с этим поступать.</p>

<p>Ссылки которые помогут:</p>

<ul>
<li>http://www.mapbender.org/Deb_Package</li>
<li>http://tldp.org/HOWTO/html_single/Debian-Binary-Package-Building-HOWTO/</li>
<li>http://www.debian.org/doc/maint-guide/</li>
<li>http://wiki.debian.org/DebianRussian/deb-inside</li>
</ul>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2013

    Sergey V. Kravchuk


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'blogalfss';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.alfss.net//post/2012/03/04/sozdaniie-deb-pakietov-na-primierie-postgresql/';
        var disqus_url = 'http://blog.alfss.net//post/2012/03/04/sozdaniie-deb-pakietov-na-primierie-postgresql/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-36118631-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



		</div>
	</div>
</body>
</html>
